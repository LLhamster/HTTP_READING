<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>聊天室</title>
  <style>
    body{font-family:sans-serif;max-width:680px;margin:20px auto;}
    #log{border:1px solid #ccc;height:300px;overflow:auto;padding:8px;white-space:pre-wrap;}
    form{display:flex;gap:8px;margin-top:8px;}
    input[type=text]{flex:1;padding:6px;}
    button{padding:6px 12px;}
  </style>
</head>
<body>
  <h2>聊天室</h2>
  <div id="log"></div>
  <form id="f">
    <input id="msg" type="text" placeholder="输入消息后回车或点发送">
    <button>发送</button>
  </form>
  <script>
    const log=document.getElementById('log');
    function append(t){
      const b=log.scrollTop+log.clientHeight>=log.scrollHeight-5;
      if(t.startsWith('<button')){
        const div=document.createElement('div');
        div.innerHTML=t;
        log.appendChild(div);
      }else{
        const textNode=document.createTextNode(t+'\n');
        log.appendChild(textNode);
      }
      if(b)log.scrollTop=log.scrollHeight;
    }
    const es=new EventSource('/events');
    es.onmessage=(e)=>append(e.data);
    es.onerror=()=>append('[系统] 连接断开，刷新页面重试');
    const f=document.getElementById('f');
    const m=document.getElementById('msg');
    f.addEventListener('submit',async(e)=>{
      e.preventDefault();
      const t=m.value.trim();
      if(!t)return;
      try{
        await fetch('/send',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body:'msg='+encodeURIComponent(t)
        });
        m.value='';
      }catch(err){
        append('[系统] 发送失败：'+err);
      }
    });
  </script>
</body>
</html>